---
title: "Magnus vs Hikaru at Titled Tuesday 2023 analysis"
author: "Torsten Blass aka https://www.youtube.com/c/TheDataDigest"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 2
    number_sections: yes
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document:
    toc: yes
    toc_depth: '2'
---


```{r setup, include=TRUE, cache=FALSE, message=FALSE, echo=FALSE}
#knitr::opts_chunk$set(cache.extra = 1) 
Sys.setenv(lang = "en_US")
knitr::opts_chunk$set(echo = TRUE)

rm(list=ls())


#setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
setwd(dir = "E:/The Data Digest/YouTube/Videos/43_Magnus_Hikaru_MVL_Alireza")
load(file = "E:/The Data Digest/YouTube/Videos/43_Magnus_Hikaru_MVL_Alireza/TitledTuesday.RData")

player_df$name[player_df$name== "Платон Гальперин"] <- "Platon Galperin"

```

```{r load-packages, include=TRUE, cache=FALSE, message=FALSE, echo=FALSE}
#install.packages("kableExtra")
library(dplyr)
library(magrittr)
library(knitr)
library(tidyverse)
library(forcats)
library(kableExtra)
library(glue) 

theme_set(new = theme_light())
```


```{r TT_long_rating, include=TRUE, message=FALSE, echo=FALSE}
## ALL players encounters ----
TT_long <- TT %>% 
  select(file_name, date_time, number, username, rating, fed, title, rnd1:rnd11) %>% 
  pivot_longer(cols = -c(file_name:title)) %>% 
  mutate(last_letter = substr(x = value, start = nchar(value), stop = nchar(value)),
         first_letter = substr(x = value, start = 1, stop = 1),
         color = if_else(last_letter == "W", "white", "black"),
         opponent_number = gsub(pattern = "[^0-9]", replacement = "", x = value),
         date_time_number = paste0(date_time, "_", number),
         date_time_opponent = paste0(date_time, "_", opponent_number)) %>% 
  left_join(data.frame(first_letter = c("W", "L", "D"), 
                       result = c("win", "lose", "draw")), by = "first_letter")  

names(TT_long)[8] <- "round"

opponent_df <- TT_long %>% select(date_time_number, username, rating)
TT$opponent_username <- TT$username ## what doing?
TT_long$opponent_username <- opponent_df$username[match(TT_long$date_time_opponent, opponent_df$date_time_number)]
TT_long$opponent_rating <- opponent_df$rating[match(TT_long$date_time_opponent, opponent_df$date_time_number)]

TT_opponent_names_df <- TT %>% select(opponent_username, name) %>% distinct()
TT_hero_names_df <- TT %>% select(username, name) %>% distinct()
names(TT_hero_names_df)[2] <- "hero_name"

TT_long <- TT_long %>% 
  left_join(TT_opponent_names_df, by = "opponent_username") %>% 
  na.omit()

TT_long <- TT_long %>% 
  left_join(TT_hero_names_df, by = "username")

names(TT_long)[17] <- "opponent_username"
names(TT_long)[19] <- "opponent_name"
names(TT_long)[5] <- "hero_rating"

```





